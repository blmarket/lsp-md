#![allow(unused)]

use std::mem::transmute;

trait Embedding {
    fn embedding(&self) -> [f32; 768];
}

pub(super) fn to_byte_array(embedding: &[f32; 768]) -> &[u8; 3072] {
    unsafe { transmute(embedding) }
}

pub(super) fn from_byte_array(bytes: [u8; 3072]) -> [f32; 768] {
    unsafe { transmute(bytes) }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_to_byte_array() {
        let embedding: [f32; 768] = {
            #[allow(invalid_value)]
            let mut arr: [f32; 768] =
                unsafe { std::mem::MaybeUninit::uninit().assume_init() };
            for (i, elem) in arr.iter_mut().enumerate() {
                *elem = (i + 1) as f32;
            }
            arr
        };
        let bytes = to_byte_array(&embedding);
        assert_eq!(bytes[0..8], [0, 0, 128, 63, 0, 0, 0, 64]);
        assert_eq!(bytes[3064..3072], [0, 192, 63, 68, 0, 0, 64, 68]);
        let emb2 = from_byte_array(bytes.clone());
        assert_eq!(emb2[0..5], [1.0, 2.0, 3.0, 4.0, 5.0]);
        assert_eq!(emb2[763..768], [764.0, 765.0, 766.0, 767.0, 768.0]);
    }
    
    #[test]
    fn decode_from_python() {
      let str = b"\x9c\xbf\x12\xbd<\xe0\x96\xbbc&\xd9\xbc\xc2\xcd\xd4<<\xea\xaa<\xa2\xf6V\xbd\x18\xcf\x1c=A-\xf9<\x1d\x8a9\xbdr>\xe7<-\xc0\xa9;_\x1a\xce\xbc_:)=\xb1\xb7\x06\xbc\xae\xc1\x1d\xbd\xc6\x18\x97\xbc\xddJ\x99\xbd\xa3\\\\\xbd\x8fh,=\x12\xf5\x08\xbdF<\xac\xbd\xf4k\xf4;\xecb>\xbd\x10S\xe5<\xd8\x98\xc2\xbc\xa5E\xa4\xbd;+\xf5<\xedKA<l<\xf8\xbcI\x97\xab\xbc!W\x08=\xc3\xd20<3\xe7:<Z|\xe5\xbc\xe6\xf1\xb7<+\x8c\xd1<_\r\x19<\xefX\x03<Z\xa5\xfa<c\xb4\x12;m\x95\x87<\x9d\x95y<\xab\x95/;\x13|\t\xbc\xa2\x0e\x1a\xbdH\xbdS;\xdb\xa8\xdd\xbc\x95\x89\x0c;\x18\xa45\xbd\xdc\xdbu9\xd2\xc5\xe6\xbbUR5\xbda\x9fr\xbb\x1a\xc1\xe5<\x92.\x02=\x8e^\xd3<Q\xd0t\xbc\xa5bn<\xeb1\x99\xbc\x1f\xaf1\xbc;4\xbb<\xdb\xc2`<\xc5\xd0\xad<-\x9fO\xbd\xe7\xe3\xb0\xbc\xd2^6=\t,\xc7<\xa5}u\xbc\x8cX\xc4<{w1\xbd\xac\xb9\x02=e\x9c\x169\x11\x1e\x14\xbd\xeb\xf0\x99\xbcX\rn=OL\x95\xbc\xe6\xe2v\xbc\xbc\xf67<D\nx=\xd0\xc3\xb2\xbd\xa0\xfe\xb0\xbd\n\xce=\xbd\xc1Kb\xbc\xd2\xfe\x9d\xbd\x02\x17\xae\xbc\x1dBQ<\r\xa1\xdf<\xde\x01\x93=\x97nz\xbc\xbc\xfa?=\x91i\xc6\xbc\xa4\xd2\xad\xbc\xfc\x85\x17<\x19\xaaR<xXM\xbd\xd02\r<\xaft\x8f\xbc\x1e7\xdb;\xbf7]\xba\xadaH\xbd\xfe\x9e~\xbc\xba:t\xbd\xd3\x90S<\xa7$\xab\xbc\xc4\xdb)=c^\x9d9\xa3\x06\x84\xbb\x1c{i<+\x8c9\xbdW\x89\xf9\xbdL\xc5N\xbd,}\xb8<\x9aU3\xbdxR==8\x84 =(\xf5\xb8\xbc\xb6\x8e\xb4<u\xc7\r\xbd\xbb\xc3,=\xb7\x1b\x1f<\xe7Y\x85\xbd\xd1\xd8t<\xc3?m=\xda\xaf\x0c<\r\xcf\x08<\xe4j\xdb\xbb\xe7B\x19\xbc\x81C\t\xbc\xf4\\\x90</\xb0\x8d;~&\x83=\xdd\x1a\xbc\xbc\x80f\x99<\'\x04\xeb\xbc[\x07\x1b\xbcgG\x0b=\x00\xbcS;\xc6\x0c\x1c\xbd\xc8\x1e\"\xbb\xd7\xe1\xbc<H\x15\x92\xbd!a\xb9;?\xa8\xa5\xbc\xb3\x8f\xe1<Y\x1e1=\xf1Vx\xbdh\x1f\x8c<B/\x12=\x05k\x1e\xbd3I\x8e;k=\x19\xbdc\x8f\xbf\xbc\x86g\xc3\xbboY\xb4<\xaeuM=V3f=\x9a\xd9\xa4=\x17\xc6\xfe<\xf6\xb1\xef\xbb\x05e\x91\xbc\xf3\xea\xc0\xbb\xef\x80P\xbd\'.\x03\xbdr\xd6\xac<\x1b\xd1$=_\xa2w<\x93\xa2{<\x97\xc3\xb2<6\x9e\'\xbd\x03\x91?<\xb7\"\x8e=L-\x0f\xbe\x04\xae\xff\xbb\x9d\x11E\xbd\x14\x94k=\x9e[\x9e\xbb\x7f\xcf\x12\xbc|&\x16\xba\x89\x03Z\xbbr\x90\x9c\xba\xf8>\xd1\xbcZ1\xbf\xbc\x87\x11\x83<E\xe3d\xbd#\x8e\x1e\xbc\x994\x1e\xbc\xf8\x8b\xf0<\xf9\xc2\x0b\xbd\x98\xe9T\xbd~w\x8a=\xf5|,\xbd*K\x98\xbc\x14zI<\xc3\xc3u\xbd\xd9\tj\xbdS\xad|\xbc\x80\x1dV=\xa0\xc8\x10\xbe\x17 \x82\xbc\x87\xf2\xf4<\x92\xc5\x9c<\\+\x02\xbd\xe4\xda\x00\xbdj\xb4O;m\xb4M\xbd\xf8<J\xbc\x96 \xb1\xbd\x87^L=\xe7\xe6L<\xc8\xa1$=7qg\xbc\x1b\x90H<\xd6\r\x04=\x93H0\xbb\xd4.(<\xf1\xab\x92\xbcl87=\x08\xccA\xbc\xde\x84[\xbd\xa1\x03y\xbd\xf0\xc4\x08<\x06P\x84\xbc{\xdc\xdc\xbb\xe9w\xc1<3\x9c\x82<W\x11Z\xbc\x1f\xac\x00=%\xaa\x96<\x9f\xb5\xea\xbb\x9f\xb0R<O\xa8\r\xbc\xc9~\xc7;o\x8e\x9a\xbc\x8bC^\xbc\r\xd1y\xbaFx!=L:A\xbcC\x10\x0e<\x98wn\xbd\x19\x99\xa0<\x96\xd3\x07<(u\xaa=/\xa9N\xbd(t\xfd<\x1c\xc1q\xbc\x8f\x0e\xb9<v\xf2\x9c:fc\xb6=\x96^#<\xfa)!\xbc+\xa9\x15=\xd4p\xd2\xbd\xd2\xb8\xa6<Bi-=(\xbfi<\x15/\xe0<\xe3\xa4\x1c\xbc(\x08x=\xa5\xce\xe1\xbc\x1aIO<9\xf2\x9d<x\x02W<\xacD\x92<\x8f/\xe9=Lfq\xbd[\x19,\xbd|\xc7\n\xbd\xc2s\x8e\xbc\x0b\xa1\x7f=\xe6\xcaK\xbd\x83*\x13\xbbB\x05\xd4\xbb22A=\x17\xa9\xff<\xc31\xc5\xbc\xaf\x9e\x02\xbd\xa3i\xf0\xbc\xe7\xd7\xe3<\xf8:\xf5;\x9dz\x86<)\x8c0=\xac9\x96<\xb9\x82\xff\xbb/#\xde\xba\xca\xea\xac\xbc\x95 (\xbc\xc9\xb0k\xbd\xd7%&\xba\x183d\xbd\xa3\x06\xfd\xbc\'\xe9\xff:\xef\tB=\xde\xddJ\xbd\xa8\xa3\x0f=z\xda\x9d\xbc\x07z-\xb9\x8bb\x82=\xf2\xc1%\xbd\xc6\x82c\xbc\xe9\xa3\xea<u\xf4\x83<\x12_\xd0\xbc-[ <\xf4\xad]\xbd\xf8\n \xbd\xcc\x87w\xbc\x07q\xdb\xbc\xfb2\x85\xbc\xbc+\x8c<\x8c`-\xba\xfds\xc4<\x171M<H7\x1c\xbc\xaa~2\xbc\xdfGz\xbc\xab\xe40;\x15\x8a\x1d\xbb\'\xb3\x93\xbd\x7f\x0e\x07\xbd\'X`=\t\xd5\x08\xbd\x86\xa4S=/\xbde=\x9f\xf9\x12=1G9=\xd3\xb9\x88\xbc>J\xff:\x1dJe<\x8f\x9b\x92=~\'m\xbd\xa8\xf3\xff\xbc\xa1\xa3\xbf<2\xa4t\xbd\x97\x9di=\xd4\xab\xd3\xbcP\x8e\x94:h\x18\xdb\xbb\xcbK\x00=\x854\xc9\xbb\xa8\x08\x95\xbd\xda/F<\x08\x0b\x1c;\x99G2\xbd\x12\x08V\xbb\xb8U\x80\xbc\xb1\x89\xdb<\x95l\xc7\xbcX\x87\xae<\xb0\x1a\x8a\xbc\x91v\x01\xbd\x809\xf4\xbc\x02\xb3$=p\x99\xcc\xbc[k\x99<\x07\x98\xd5<c\xe6|=;\xe8\x05\xbd\xc4\xcc\x17\xbd\xfc\xa4/=KM\x15\xbd\x89\x14\x1c<r{\xe6\xbam\x1f0\xbd\"x\x7f\xbb\x8c\xda\x1e;\x11\xe0\xa4;\x9c\x1c\xa4\xbdo\x8d}<\xbd\xa0\x07=\x1f\xef\x01<\xd6}\x85;\x07\xa4\xb8<\xba\x06\xa2<5\xf8\xa5\xbc\xb5}9\xbd\xe9\xa1\x05<\xeb\xe3\xa6\xbcS\x98|<\x05\x17\xea\xbb\x1d\x1a\x04=\x1f\xafu\xbc|\x1b\xb8\xbc\x07b\x84\xbc\xdb_\x1c\xbc\x89\xd5\x8c\xbbt\x05\xa2\xbc\xc2\x165=\xbe\xe4U<~\xdc\xbe;\x02/5\xbc\xedp0<\x9434=\x9e+#\xbc\xf3\xa1\x1f\xbd\xfb\x95\xd5\xbc0\xa2\x8a=\xd4\xd8\xcf\xbc\x08\xe5\xdd<8\xf7\x8a\xbc$pO\xbd5\xed\xa0<\x84\xa9\x0f\xbb\xc9\x0b\xab\xbc\xae\xef\xb5\xbd\x1fj\x06<\xc8\xdb*\xbce\xcb3=^a1=\n\xcb\xee;-\xf6_\xbd\\F\x8b<Z\x9c\xc9\xbca\xdaK\xbb\x06f\x0e\xbdh\xf3\xca<\x8a\x0e\xb7\xbcQ\x80c\xbc\x94(E\xbdZ^_:\xeb{\xf8<#M\xba<\xd5\x9d\x08<&`A\xbd1\x9c\xa0<J\x17\x19=;\xd8\xb2:.\xa0\x7f\xbdp#4<\xeab\xfd\xbc\xaac\x95\xbd\x03j\x1c\xbd\x81N\xf9<\x9f\xd2*\xbd\x88E\xcb\xbdDs\xf3\xbcKkN\xbd8\xe4\xa0=b\xe6d=\xde,\x80;x\xcb\x1d\xbc%e^;\x9b\xce\xc9< \x925\xbd\x08\xd5\xc8\xbb\x8a\xcb\xf4<]\x93\x1c\xbd\xa1TL\xbc\xa6^3\xbc?\r\xb5\xbc\xf0\xa3~\xbd\x84\xfbS\xbc<\xd3\xa3\xbcrG\x83<o\x9f\xa3=\xcf\x80\x7f\xbc\xde\r\x83<\xb0\x9a\x9c<\xf3j\xfd\xba5\xc5\xac<\xc7\x86!<\xa4d=;\xba\xef\xf0\xbcE\xf2S\xbd\x1a\xfc\x9f=v9.\xbbF\xd3\xf4\xbc\xce\xc9\x00=\x06z\x81=d\xea\xf2\xbc\x9d\'\x7f=\x859V\xbd\x0ez~\xbb\x15\xb1\xb7\xbc=\x8eL\xbd\xeay\x8c\xbaV;b<B\xa5m=\x9dq\\=t\xeeS\xbd\x17M\x17\xbc\xbd\xbb6\xbd4IG\xbcb@$\xbb\xf6\xceA\xbd\xff\xfb\xe3;;\n\xc4<mg\xc3\xbcH`\x15=f4\xd1<H\x00\x81<\xd0\x08\xde<\x15\x86~\xbd\xb68\x91\xbc\xd9\xe8\x01\xbdd\x11\xdf\xbaFG\x12\xbb\xe4m\x0e\xbb\xe2>1;\x8cE\xbc<`\xbe\x1a=\xe9Lo=\xbe\xb09<\x021p<\x0c\x9d\x98\xbc\x06\x94-\xbd\xc9B\xf5<\x8a\x92\xb1:H-H\xbd\xb0\xa5\"\xbd;\x16\x1c=\x03U\xc2<\x95H\x9e=E\x0b\x1c=\x8da\xaf\xbc\xa3\xcc-\xbd\rHT\xbd\xbe,\xfa\xbc\x8d\xca\':\xbd\x95\x02<P]\x0c\xbcfk\x08\xbc\xab\xdc\\\xbdZ\x0f\xc4\xbb\xa6\xbd\xff;\x80\xcc\r\xbcn\x18\xcf<\"\x92\x1e=\x1e$7\xbc5o\xd2\xbc\xa5\x8c\x83\xbcO|\x11<\x1d\xd1L\xbb\xb1?\xcf;\xe0\xa1\x1d;%Yz\xbc\xec\xba+\xbd\xe1\xf0\x99=\x7f\xec\x1b;\xbeR\x0c=!\xdb\x81=\x06K\x1b\xbdYG\x7f\xbd\xff\xbeT<4\xbdt=\xea\xf0\x98<\x9b\xd7\x8d\xbcD3b=\xdc\x10\x9e\xbcq\xd97=kZ>=\xf5\xab\xe2<\xc2w\"\xbd@k\x01\xb9\x92\xe9\x9f=R\xcf\x0c=\x0c\x8eJ\xbd\x12/\x08=\xb2\x97A\xbd\xe9!s\xbc] ]\xbb\xa5\xc9\xe3<\xec\n\x8e<z\x8f\x86\xbd\xd2\xaa\x8f\xbc\x02\xa6\n=\xee\xa9\x8f\xbbT;|=\x04\xc1\n\xbc\xe0\x86^\xbcx\x8b\x9d=\xa3\xdb9\xbd>\x1c\x83\xbd?{\xd1\xbc\xc7\x89\x1c\xbd\x1d\xb3\xe3<\x93bS=\xb2\x08(\xbd\xec\xecb\xbc\xb5\x0c\x8c<\xf7\x8d5=n^9;B\xed\xbd< \xa1V\xbd\xea\xb37=\xa2\xd3\x88;a\r\x879\xbd\xd5\xab\xbb\xb3wn\xbd0\xd8\xf0\xbc\xca&\xf8\xbc\xcdW)\xbd\x956a\xbd\xc8\xb5\xa3;ZD\xa5\xbc[Ku\xbdx\x83S\xbdn?\xd4\xbc\x9fj\x96\xbc\xddE\xdb<`\xd1\x02\xbd\xc7 \x12<\x19\xf0?<G\xfdc\xbc\x13\x85\x03\xbdo4m=\xf9\x89\xcf<\xa2\x05+=2Ak<g$\x9d;\x9aJ*<\x8d\xeeN=+p\x15=\x01\xe4\x13=b\xc2\x02<K\x85\xa3\xbcC\xf0\"<\x83\x14\xa6\xbcj\xf2n=b\xf0s<\xd9\x8el8\xbc\'.=\x98\xdd\xf6<\x99\xe4\xb6\xbcH3Y\xbb\xeb~\x88\xbc\xcdO\x99\xbd`-\xc0<?%\xa4\xbc\x05\xe8\xe7;\xfep\x08\xbcv.n<3\x1b$\xbdS\x8b\x80\xbd\x06\xec\x9d\xbd\xbb\xd90={\xe1\\\xbd\x96\x96\x03\xbc\xe5X\xb0:\x84l_=H4\xc0<\x9e\xdb\x84=H\xef]<\xf7W\xc4<\x12g\xb5\xbc`\xdb\xc0\xbc\xd1U\xab\xbc\xb9\x14\x08\xbc\x01\x8f*\xbd\x02O\"<\x87\xfa\xce<{y\x91<T\xeeP\xbd9*\xa9\xbc6mU\xbd\xebQ\xb5<\xa5e\xce<\xf5Y\x02\xbc\xd5\x7f3=\xb56\x8c\xbd\xdc\xbc,=\xfewe\xbb\xfaN:=]\xde\x15\xbc\x185\x82=\x98\xe37\xbd:\x1c\xa7=\xef\xdbc\xbd\"(\xf0<B\xd8\x11=\xfc\xf3\x1a=\xf2\xd6\x89\xbb\xa13R\xbd\x05&\x18=Dz\x9a\xbd\xf5\x1c\xce<r\x04\x0f=\x96\x05>\xbcnwz=\xed\xe5[=v\xbf\xa9<\xbb\x9dG\xbdRm\xdf;\xe4\xfc\x93;J\x98_\xbd\x9e-\xe8\xbb\xd8\xd0\xf4\xbb*\xc8\xaa<Q\x1f\xad\xbc\xa9\xd3\xaf\xbc\x83\x92\x0e\xbc\xdf0\xdb\xbb9\xee\xdf\xb9\x95\xb9s\xbd\xf4\xff\x96\xbc\xa7\x97\x1e\xbc\xee\xdd\x82\xbd\xdf\xba>\xbd\xc1\x10G=+7\xe9\xbc;\x18\x0e\xbc\x1e\xb7*\xbd\x8d\x96y<\xfc\x90\x0f=\xfd[\n=<\xd34= C\xf1\xbc\x81\x19;\xbd\x92\x10\x19<l\x9a\x1f\xbc\xbb\xfd4\xbd\xf6Pn\xbat\xc0\xf8\xbc\xd2\x07\'=\x8f\xd8R<K\xc7\xe4\xbb!h\x81=\xe9\xa9\xb7;m\xb6\xf6<:L\xb5<\xaf\xca%=\xe4\xeaN\xbcx\xa5I:\x08\xb1\xcd<\xf8\x06L\xbd\xeb\xbc\xdf\xbc\x81\x869<+\x8bI<\xc9<O\xbd}\x90\x87<8\x19o\xbcK\xea9;\x1c5\x18\xbd5\xa9+=S+Y<E\x0bk\xbbp\x11\xa3\xbc\x8a+\x95=G\x05\xc0;{\x9a\x16=S\xa9/\xbdgH\x84\xbc@\xeb\x01=\x9c\x81\xef;\xdd\xdaN\xbc\xa7\x93\xb1<\x933\x9b\xbc?\xecB<\xda\x11\x0b\xbdo\x01\x16\xbd\x9e\x7f@\xbd{\xa6H\xbd\x1f\xcb <\x90\xfds;\xc4\x82\xce<I[ \xbc\xee0\x8d=\x84\x02X<fu\x99;\x86\x93\xa0\xbbTB\x98=<\xf8\x01=Y\x0b`;\xb8?_\xbc\xeeAV=,21=\x96\xb8\x1d=\x9f\x84\xb9\xbc\x10\xf3m\xbd";
      let emb = from_byte_array(*str);
      assert_eq!(emb[767], -0.05809313);
      assert_eq!(emb[766], -0.022646246);
    }
}
